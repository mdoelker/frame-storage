/*! frame-storage - v1.0.0 - 2015-11-06; Copyright (c) 2015 Malte DÃ¶lker; Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof module&&module.exports?module.exports=b():a.FrameStorage=b()}(this,function(){"use strict";function a(a){var b=document.createElement("div");b.id="framestorage-"+h(),b.style.display="none",document.body.appendChild(b);var g,j,k,l,m=[],n=null,o=location.protocol+"//"+location.host,p=a.match(/^(https?:\/\/[a-z0-9-.:@]+)\/?/i)||[null,o],q=p[1];return i({root:b,url:a,width:1,height:1,onload:function(a){n=a.contentWindow,g=c.bind(null,n),j=d.bind(null,n,q),k=e.bind(null,n,q),l=f.bind(null,n,q),window.addEventListener("message",g,!1),m.forEach(function(a){switch(a[0]){case"save":j.apply(null,a[1]);break;case"load":k.apply(null,a[1])}}),m=[]}}),{setItem:function(){j?j.apply(null,arguments):m.push(["save",arguments])},getItem:function(){k?k.apply(null,arguments):m.push(["load",arguments])},clear:function(){l?l.apply(null,arguments):m.push(["empty",arguments])},destroy:function(){b&&(document.body.removeChild(b),b=null),n&&(window.removeEventListener("message",g,!1),n=null),g=null,j=null,k=null}}}function b(a){null==a&&(a="*"),window.addEventListener("message",function(b){if("*"!==a&&b.origin!==a)return void console.error("Origin mismatch");var c=JSON.parse(b.data),d=function(d){g(b.source,{action:"frameStorageSuccess",ref:c.ref,key:c.key,value:d},a)},e=function(d){g(b.source,{action:"frameStorageError",ref:c.ref,key:c.key,message:d.message},a)};switch(c.action){case"setItem":try{localStorage.setItem(c.key,c.value),d(null)}catch(f){e(f)}break;case"getItem":try{var h=localStorage.getItem(c.key);d(h)}catch(f){e(f)}break;case"clear":try{localStorage.clear(),d()}catch(f){e(f)}break;default:return void console.error("Unknown action")}},!1)}function c(b,c){if(c.source===b){var d=JSON.parse(c.data),e=a._callbacks[d.ref]||function(){};switch(d.action){case"frameStorageSuccess":e(null,d.value);break;case"frameStorageError":e(d.message,null);break;default:console.error("Unknown action")}delete a._callbacks[d.ref]}}function d(b,c,d,e,f){var i=h();f&&(a._callbacks[i]=f),g(b,{action:"setItem",ref:i,key:d,value:e},c)}function e(b,c,d,e){var f=h();e?a._callbacks[f]=e:console.warn("FrameStorage.getItem: Missing callback function"),g(b,{action:"getItem",ref:f,key:d},c)}function f(b,c,d){var e=h();d?a._callbacks[e]=d:console.warn("FrameStorage.clear: Missing callback function"),g(b,{action:"clear",ref:e},c)}function g(a,b,c){a.postMessage(JSON.stringify(b),c)}function h(){return"c"+(Math.random()*(1<<30)).toString(16).replace(".","")}function i(b){b.id=b.id||h(),b.name=b.name||h();var c=h(),d=!1,e=!1;if(a._callbacks[c]=function(){d&&!e&&(e=!0,b.onload&&b.onload(b.root.firstChild))},document.attachEvent){var f='<iframe id="'+b.id+'" name="'+b.name+'"'+(b.className?' class="'+b.className+'"':"")+' style="border:none;'+(b.width?"width:"+b.width+"px;":"")+(b.height?"height:"+b.height+"px;":"")+'" src="'+b.url+'" frameborder="0" scrolling="no" allowtransparency="true" onload="FrameStorage._callbacks.'+c+'()"></iframe>';b.root.innerHTML='<iframe src="javascript:false" frameborder="0" scrolling="no" style="height:1px"></iframe>',d=!0,window.setTimeout(function(){b.root.innerHTML=f},0)}else{var g=document.createElement("iframe");g.id=b.id,g.name=b.name,g.onload=a._callbacks[c],g.style.border="none",g.style.overflow="hidden",b.className&&(g.className=b.className),b.height&&(g.style.height=b.height+"px"),b.width&&(g.style.width=b.width+"px"),b.root.appendChild(g),d=!0,g.src=b.url}}return a.initChannel=b,a._callbacks={},a});